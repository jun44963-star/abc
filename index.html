<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>네이버 통합 본문 추출기 (블로그/카페/티스토리)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { margin:0; padding:20px; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; background:#020617; color:#e5e7eb; }
    .wrapper { max-width:720px; margin:0 auto; padding:24px 20px; background:#020617; border-radius:16px; border:1px solid #1f2937; box-shadow:0 20px 40px rgba(0,0,0,0.6); }
    h1 { margin:0 0 10px; font-size:1.4rem; }
    label { font-size:0.9rem; color:#9ca3af; }
    input, textarea { width:100%; margin:6px 0 14px; padding:12px; background:#0f172a; border:1px solid #1f2937; color:#e5e7eb; border-radius:10px; box-sizing:border-box; }
    textarea { min-height:240px; white-space:pre-wrap; }
    button { width:100%; padding:12px; border:none; border-radius:999px; font-weight:700; cursor:pointer; }
    #pasteBtn { background:#3b82f6; color:#e5f2ff; }
    #pasteBtn:hover { background:#2563eb; }
    #extractBtn { background:#22c55e; color:#022c22; margin-top:6px; }
    #extractBtn:hover { background:#16a34a; }
    #copyBtn { background:#1e293b; color:#e5e7eb; margin-top:8px; }
    #copyBtn:hover { background:#334155; }
    .status { font-size:0.8rem; margin:8px 0; color:#9ca3af; min-height:1rem; }
    .success { color:#4ade80 !important; }
    .error { color:#f87171 !important; }
  </style>
</head>

<body>
<div class="wrapper">
  <h1>네이버 통합 본문 추출기</h1>

  <label>블로그 / 카페 / 티스토리 주소</label>
  <input id="urlInput" type="text" placeholder="https://blog.naver.com/... 또는 https://cafe.naver.com/...">

  <button id="pasteBtn">Ctrl+V로 주소 붙여넣기</button>
  <button id="extractBtn">본문 추출하기</button>
  <button id="copyBtn">복사하기</button>

  <div id="status" class="status"></div>

  <label>추출된 본문</label>
  <textarea id="output"></textarea>
</div>

<script>
const WORKER_URL = "https://curly-mud.jun1317.workers.dev/";

const $ = (id)=>document.getElementById(id);
const urlInput = $("urlInput");
const output = $("output");
const statusBox = $("status");
const extractBtn = $("extractBtn");
const pasteBtn = $("pasteBtn");
const copyBtn = $("copyBtn");

function setStatus(msg,type=""){ statusBox.textContent=msg; statusBox.className="status "+type; }

// 블로그 URL 정규화
function normalizeUrl(url){
  const m = url.match(/^https?:\/\/blog\.naver\.com\/([^\/]+)\/(\d+)/);
  if(m){
    return `https://blog.naver.com/PostView.naver?blogId=${m[1]}&logNo=${m[2]}`;
  }
  return url;
}

function cleanText(text){
  if(!text) return "";
  text = text.replace(/[\u{1F300}-\u{1FAFF}\u{2600}-\u{27BF}\u{FE0F}]/gu,"");
  text = text.replace(/^\s*\d{4}\.\s*\d{1,2}\.\s*\d{1,2}.*$/gm,"");
  text = text.replace(/URL\s*복사|이웃추가|공유하기|신고하기|본문\s*기타\s*기능/g,"");
  text = text.replace(/\r\n/g,"\n").replace(/\n{3,}/g,"\n\n").trim();
  text = text.replace(/\s+([,\.!?;:~…])/g,"$1");
  const lines = text.split("\n").map(l=>l.trim()).filter(l=>l && !/^#/.test(l));
  return lines.join(" ").replace(/\s+/g," ").trim();
}

async function fetchHTML(url){
  const res = await fetch(WORKER_URL+"?url="+encodeURIComponent(url));
  if(!res.ok) throw new Error("proxy fetch error");
  return await res.text();
}

// 카페 iframe src 추출
function extractCafeIframe(html){
  let m = html.match(/\$\("cafe_main"\)\.src\s*=\s*"([^"]+)"/);
  if(m) return m[1].replace(/&amp;/g,"&");

  // 새로운 구조 대응
  m = html.match(/<iframe[^>]+id=["']mainFrame["'][^>]+src=["']([^"']+)["']/);
  if(m) return m[1].replace(/&amp;/g,"&");

  return null;
}

async function extract(){
  let url = urlInput.value.trim();
  if(!url){ alert("주소를 입력해 주세요"); return; }

  url = normalizeUrl(url);
  output.value="";
  extractBtn.disabled=true;
  setStatus("HTML 가져오는 중...");

  try{
    let html = await fetchHTML(url);
    let targetHtml = html;

    // 네이버 카페라면 iframe 따라가기
    if(url.includes("cafe.naver.com")){
      const iframeSrc = extractCafeIframe(html);
      if(iframeSrc){
        setStatus("카페 본문 iframe 불러오는 중...");
        let realUrl = iframeSrc.startsWith("//")
          ? "https:"+iframeSrc
          : iframeSrc.startsWith("/")? "https://cafe.naver.com"+iframeSrc : iframeSrc;

        try{
          targetHtml = await fetchHTML(realUrl);
        }catch(e){
          console.warn("iframe fetch fail:",e);
        }
      }
    }

    setStatus("본문 분석 중...");
    const parser = new DOMParser();
    const doc = parser.parseFromString(targetHtml,"text/html");

    const bodyText = doc.body.innerText||"";
    if(/네트워크 문제|잠시 후에 다시 시도/.test(bodyText)){
      setStatus("카페 글 접근 제한: 공개 글이라도 로그인/앱전용일 수 있음","error");
      extractBtn.disabled=false;
      return;
    }

    // 본문 후보 셀렉터
    const selectors = [
      ".se-main-container",".se-viewer",".se_viewArea","#postViewArea",".post_view","._postView",
      ".article_view","#article",".entry-content","#content",".tt_article_useless_p_margin",
      ".ArticleContent",".article_cont",
      // 카페용
      "#content-area",".content-area",".article_content",".article_viewer","[data-viewer-type]"
    ];

    let content = "";

    for(const sel of selectors){
      const el = doc.querySelector(sel);
      if(el){
        const txt = el.innerText.trim();
        if(txt.length>30){ content=txt; break; }
      }
    }

    // 백업: div 중 가장 긴 텍스트
    if(!content){
      let longest="";
      doc.querySelectorAll("div").forEach(d=>{
        const t = d.innerText.trim();
        if(t.length>longest.length) longest=t;
      });
      content=longest;
    }

    if(!content.trim()){
      setStatus("본문을 찾지 못했습니다. (카페 구조 특이 가능)","error");
      extractBtn.disabled=false;
      return;
    }

    const cleaned = cleanText(content);
    output.value = cleaned;
    navigator.clipboard.writeText(cleaned).catch(()=>{});
    setStatus("본문 추출 완료 (자동 복사됨)","success");

  }catch(e){
    console.error(e);
    setStatus("오류 발생: "+e.message,"error");
  }

  extractBtn.disabled=false;
}

extractBtn.addEventListener("click",extract);

pasteBtn.addEventListener("click",async ()=>{
  try{
    const text = await navigator.clipboard.readText();
    if(!text){ alert("클립보드에 주소가 없습니다."); return; }
    urlInput.value = text.trim();
    setStatus("주소 붙여넣기 완료 → 자동 추출 시작");
    extract();
  }catch(e){
    alert("브라우저에서 클립보드 읽기 차단됨. 직접 Ctrl+V 하세요.");
  }
});

copyBtn.addEventListener("click",()=>{
  if(!output.value.trim()){ alert("복사할 내용 없음"); return; }
  navigator.clipboard.writeText(output.value.trim());
  setStatus("복사 완료","success");
});

urlInput.addEventListener("paste",()=>{
  setTimeout(()=>{ if(urlInput.value.trim()) extract(); },10);
});

</script>
</body>
</html>
